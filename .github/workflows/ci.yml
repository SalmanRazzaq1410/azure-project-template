name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  detect-stack:
    runs-on: ubuntu-latest
    outputs:
      stack: ${{ steps.detect.outputs.stack }}
    steps:
      - uses: actions/checkout@v4

      - name: Detect tech stack
        id: detect
        run: |
          echo "Detecting tech stack..."

          if [ -f "requirements.txt" ] || [ -f "pyproject.toml" ]; then
            echo "stack=python" >> $GITHUB_OUTPUT
            echo "Detected: Python"
          elif [ -f "package.json" ]; then
            echo "stack=nodejs" >> $GITHUB_OUTPUT
            echo "Detected: Node.js"
          elif [ -f "go.mod" ]; then
            echo "stack=go" >> $GITHUB_OUTPUT
            echo "Detected: Go"
          elif ls *.csproj 1> /dev/null 2>&1 || ls **/*.csproj 1> /dev/null 2>&1; then
            echo "stack=dotnet" >> $GITHUB_OUTPUT
            echo "Detected: .NET"
          elif [ -f "pubspec.yaml" ]; then
            echo "stack=flutter" >> $GITHUB_OUTPUT
            echo "Detected: Flutter"
          else
            echo "stack=unknown" >> $GITHUB_OUTPUT
            echo "Warning: Could not detect tech stack"
          fi

  lint-python:
    needs: detect-stack
    if: needs.detect-stack.outputs.stack == 'python'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff black isort

      - name: Lint with ruff
        run: ruff check . --ignore E501
        continue-on-error: true

      - name: Check formatting with black
        run: black --check . || true

      - name: Check imports with isort
        run: isort --check-only . || true

  test-python:
    needs: detect-stack
    if: needs.detect-stack.outputs.stack == 'python'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install pytest pytest-cov pytest-asyncio httpx

      - name: Run tests
        run: |
          if [ -d "tests" ]; then
            pytest tests/ --cov=. --cov-report=xml --cov-report=term -v
          else
            echo "No tests directory found, skipping tests"
          fi

      - name: Upload coverage
        if: success()
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
        continue-on-error: true

  lint-nodejs:
    needs: detect-stack
    if: needs.detect-stack.outputs.stack == 'nodejs'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci || npm install

      - name: Lint
        run: npm run lint || echo "No lint script found"

  test-nodejs:
    needs: detect-stack
    if: needs.detect-stack.outputs.stack == 'nodejs'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci || npm install

      - name: Run tests
        run: npm test || echo "No test script found"

  lint-go:
    needs: detect-stack
    if: needs.detect-stack.outputs.stack == 'go'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: golangci-lint
        uses: golangci/golangci-lint-action@v4
        with:
          version: latest

  test-go:
    needs: detect-stack
    if: needs.detect-stack.outputs.stack == 'go'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Run tests
        run: go test -v -race -coverprofile=coverage.out ./...

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.out
        continue-on-error: true

  build-dotnet:
    needs: detect-stack
    if: needs.detect-stack.outputs.stack == 'dotnet'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Restore dependencies
        run: dotnet restore

      - name: Build
        run: dotnet build --no-restore

      - name: Test
        run: dotnet test --no-build --verbosity normal

  build-flutter:
    needs: detect-stack
    if: needs.detect-stack.outputs.stack == 'flutter'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.16.0'
          channel: 'stable'

      - name: Install dependencies
        run: flutter pub get

      - name: Analyze
        run: flutter analyze

      - name: Run tests
        run: flutter test

  bicep-lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bicep
        run: |
          curl -Lo bicep https://github.com/Azure/bicep/releases/latest/download/bicep-linux-x64
          chmod +x ./bicep
          sudo mv ./bicep /usr/local/bin/bicep

      - name: Lint Bicep files
        run: |
          if [ -f "infra/main.bicep" ]; then
            bicep build infra/main.bicep
            echo "✅ Bicep validation passed"
          else
            echo "No Bicep files found, skipping"
          fi

  docker-build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build Docker image
        run: |
          if [ -f "Dockerfile" ]; then
            docker build -t app:test .
            echo "✅ Docker build successful"
          else
            echo "No Dockerfile found, skipping"
          fi

  security-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'
        continue-on-error: true
