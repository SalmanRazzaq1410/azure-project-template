name: üöÄ Initialize Project

permissions:
  contents: write
  issues: write

on:
  # Manual trigger with form (RECOMMENDED)
  workflow_dispatch:
    inputs:
      org:
        description: 'Organization'
        required: true
        type: choice
        options:
          - nl
          - pvc
          - tws
          - mys
      env:
        description: 'Environment'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
      project:
        description: 'Project name (lowercase, 2-20 chars, no spaces)'
        required: true
        type: string
      techstack:
        description: 'Tech Stack'
        required: true
        type: choice
        options:
          - fastapi
          - fastapi-hexagonal
          - nodejs
          - go
          - dotnet
          - flutter
          - reactnative
      region:
        description: 'Azure Region'
        required: true
        type: choice
        default: 'euw'
        options:
          - euw
          - eus
          - wus
          - san
          - saf

  # Auto-trigger on repo creation (fallback - parses repo name)
  create:

  # Auto-trigger on first push (fallback)
  push:
    branches:
      - main

jobs:
  # ===========================================================================
  # Determine configuration source
  # ===========================================================================
  configure:
    if: github.event.repository.name != 'azure-project-template'
    runs-on: ubuntu-latest
    outputs:
      org: ${{ steps.config.outputs.org }}
      env: ${{ steps.config.outputs.env }}
      project: ${{ steps.config.outputs.project }}
      techstack: ${{ steps.config.outputs.techstack }}
      region: ${{ steps.config.outputs.region }}
      should_run: ${{ steps.config.outputs.should_run }}

    steps:
      - uses: actions/checkout@v4

      - name: Check if already initialized
        id: check
        run: |
          # Check if project has been initialized (templates folder removed)
          if [ ! -d "templates" ]; then
            echo "already_initialized=true" >> $GITHUB_OUTPUT
            echo "‚è≠Ô∏è Project already initialized, skipping..."
          else
            echo "already_initialized=false" >> $GITHUB_OUTPUT
          fi

      - name: Determine configuration
        id: config
        if: steps.check.outputs.already_initialized != 'true'
        run: |
          # Check if triggered manually with inputs
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "üìù Using manual workflow inputs..."
            echo "org=${{ inputs.org }}" >> $GITHUB_OUTPUT
            echo "env=${{ inputs.env }}" >> $GITHUB_OUTPUT
            echo "project=${{ inputs.project }}" >> $GITHUB_OUTPUT
            echo "techstack=${{ inputs.techstack }}" >> $GITHUB_OUTPUT
            echo "region=${{ inputs.region }}" >> $GITHUB_OUTPUT
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            echo "üîç Attempting to parse repository name..."
            REPO_NAME="${{ github.event.repository.name }}"
            IFS='-' read -ra PARTS <<< "$REPO_NAME"

            ORG="${PARTS[0]}"
            ENV="${PARTS[1]}"
            PROJECT="${PARTS[2]}"
            TECHSTACK="${PARTS[3]}"

            # Validate all parts exist
            if [ -n "$ORG" ] && [ -n "$ENV" ] && [ -n "$PROJECT" ] && [ -n "$TECHSTACK" ]; then
              # Validate org
              if [[ "$ORG" =~ ^(nl|pvc|tws|mys)$ ]] && \
                 [[ "$ENV" =~ ^(dev|staging|prod)$ ]] && \
                 [[ "$TECHSTACK" =~ ^(fastapi|fastapi-hexagonal|nodejs|go|dotnet|flutter|reactnative)$ ]]; then
                echo "‚úÖ Valid repo name format detected"
                echo "org=$ORG" >> $GITHUB_OUTPUT
                echo "env=$ENV" >> $GITHUB_OUTPUT
                echo "project=$PROJECT" >> $GITHUB_OUTPUT
                echo "techstack=$TECHSTACK" >> $GITHUB_OUTPUT
                echo "region=euw" >> $GITHUB_OUTPUT
                echo "should_run=true" >> $GITHUB_OUTPUT
              else
                echo "‚ö†Ô∏è Repo name doesn't match expected pattern"
                echo "should_run=false" >> $GITHUB_OUTPUT
              fi
            else
              echo "‚ö†Ô∏è Could not parse repo name into required parts"
              echo "should_run=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Create setup instructions issue
        if: steps.check.outputs.already_initialized != 'true' && steps.config.outputs.should_run != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            // Check if setup issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'setup',
              state: 'open'
            });

            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'üöÄ Initialize Your Project',
                labels: ['setup'],
                body: `## Welcome to your new project!

Your repository was created from the **azure-project-template** but needs to be configured.

### How to Initialize

1. Go to the **Actions** tab
2. Click on **"üöÄ Initialize Project"** workflow
3. Click **"Run workflow"**
4. Fill in the form:
   - **Organization:** Your org code (nl, pvc, tws, mys)
   - **Environment:** dev, staging, or prod
   - **Project name:** lowercase, no spaces (e.g., myapi)
   - **Tech Stack:** Choose your framework
   - **Region:** Azure region code

### Available Tech Stacks

| Stack | Description |
|-------|-------------|
| \`fastapi\` | Python FastAPI (simple) |
| \`fastapi-hexagonal\` | Python with Clean Architecture |
| \`nodejs\` | Node.js Express |
| \`go\` | Go standard library |
| \`dotnet\` | .NET 8 Minimal API |
| \`flutter\` | Flutter mobile/web |
| \`reactnative\` | React Native (Expo) |

### After Initialization

Once you run the workflow, this issue will be automatically closed and your project will be ready to use!

---
*This issue was created automatically because the repository name didn't follow the auto-configuration pattern.*
`
              });
              console.log('Created setup instructions issue');
            }

  # ===========================================================================
  # Run setup
  # ===========================================================================
  setup:
    needs: configure
    if: needs.configure.outputs.should_run == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Display configuration
        run: |
          echo "=========================================="
          echo "üîß Project Configuration"
          echo "=========================================="
          echo "  Organization: ${{ needs.configure.outputs.org }}"
          echo "  Environment:  ${{ needs.configure.outputs.env }}"
          echo "  Project:      ${{ needs.configure.outputs.project }}"
          echo "  Tech Stack:   ${{ needs.configure.outputs.techstack }}"
          echo "  Region:       ${{ needs.configure.outputs.region }}"
          echo "=========================================="

      - name: Validate project name
        run: |
          PROJECT="${{ needs.configure.outputs.project }}"
          if [[ ! "$PROJECT" =~ ^[a-z0-9]{2,20}$ ]]; then
            echo "‚ùå ERROR: Invalid project name '$PROJECT'"
            echo "   Must be 2-20 lowercase alphanumeric characters"
            exit 1
          fi
          echo "‚úÖ Project name is valid"

      - name: Select tech stack template
        run: |
          TECHSTACK="${{ needs.configure.outputs.techstack }}"

          if [ -d "templates/$TECHSTACK" ]; then
            echo "‚úÖ Using tech stack: $TECHSTACK"
            cp -r templates/$TECHSTACK/* .
          else
            echo "‚ö†Ô∏è Tech stack '$TECHSTACK' not found, using fastapi"
            cp -r templates/fastapi/* .
          fi

          # Remove templates directory
          rm -rf templates/

      - name: Process template files
        run: |
          ORG="${{ needs.configure.outputs.org }}"
          ENV="${{ needs.configure.outputs.env }}"
          PROJECT="${{ needs.configure.outputs.project }}"
          TECHSTACK="${{ needs.configure.outputs.techstack }}"
          REGION="${{ needs.configure.outputs.region }}"
          RESOURCE_GROUP="${ORG}-${ENV}-${PROJECT}-rg-${REGION}"

          echo "üìù Processing template files..."

          # Process .template files first
          find . -name "*.template" -type f | while read file; do
            output="${file%.template}"
            sed -e "s/{{ORG}}/$ORG/g" \
                -e "s/{{ENV}}/$ENV/g" \
                -e "s/{{PROJECT}}/$PROJECT/g" \
                -e "s/{{TECHSTACK}}/$TECHSTACK/g" \
                -e "s/{{REGION}}/$REGION/g" \
                -e "s/{{RESOURCE_GROUP}}/$RESOURCE_GROUP/g" \
                "$file" > "$output"
            rm "$file"
            echo "  ‚úì Processed: $file ‚Üí $output"
          done

          # Replace placeholders in all text files
          find . -type f \( \
            -name "*.py" -o \
            -name "*.cs" -o \
            -name "*.js" -o \
            -name "*.ts" -o \
            -name "*.tsx" -o \
            -name "*.jsx" -o \
            -name "*.go" -o \
            -name "*.dart" -o \
            -name "*.java" -o \
            -name "*.bicepparam" -o \
            -name "*.bicep" -o \
            -name "*.json" -o \
            -name "*.md" -o \
            -name "*.yml" -o \
            -name "*.yaml" -o \
            -name "*.env*" -o \
            -name "*.txt" -o \
            -name "*.toml" -o \
            -name "*.ini" -o \
            -name "*.conf" -o \
            -name "*.csproj" -o \
            -name "Dockerfile*" -o \
            -name "Makefile" \
          \) ! -path "./.git/*" -exec sed -i \
            -e "s/{{ORG}}/$ORG/g" \
            -e "s/{{ENV}}/$ENV/g" \
            -e "s/{{PROJECT}}/$PROJECT/g" \
            -e "s/{{TECHSTACK}}/$TECHSTACK/g" \
            -e "s/{{REGION}}/$REGION/g" \
            -e "s/{{RESOURCE_GROUP}}/$RESOURCE_GROUP/g" \
            {} +

          echo "‚úÖ Template processing complete"

      - name: Rename project-specific files
        run: |
          PROJECT="${{ needs.configure.outputs.project }}"
          find . -name "*{{PROJECT}}*" -type f | while read file; do
            newname=$(echo "$file" | sed "s/{{PROJECT}}/$PROJECT/g")
            mv "$file" "$newname"
            echo "  ‚úì Renamed: $file ‚Üí $newname"
          done

      - name: Update README
        run: |
          PROJECT="${{ needs.configure.outputs.project }}"
          ORG="${{ needs.configure.outputs.org }}"
          ENV="${{ needs.configure.outputs.env }}"
          TECHSTACK="${{ needs.configure.outputs.techstack }}"

          # Create a project-specific README if template exists
          if [ -f "README.md.template" ]; then
            mv README.md.template README.md
          fi

      - name: Commit changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add .
          git diff --staged --quiet || git commit -m "üéâ Initialize ${{ needs.configure.outputs.project }} (${{ needs.configure.outputs.techstack }})"

      - name: Push changes
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref }}

      - name: Close setup issue
        uses: actions/github-script@v7
        with:
          script: |
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'setup',
              state: 'open'
            });

            for (const issue of issues.data) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed'
              });

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `## ‚úÖ Project Initialized Successfully!

**Configuration:**
- **Organization:** ${{ needs.configure.outputs.org }}
- **Environment:** ${{ needs.configure.outputs.env }}
- **Project:** ${{ needs.configure.outputs.project }}
- **Tech Stack:** ${{ needs.configure.outputs.techstack }}
- **Region:** ${{ needs.configure.outputs.region }}

Your project is ready! Next steps:
1. Clone the repository
2. Run \`make install\` to install dependencies
3. Run \`make dev\` to start development server
4. Check \`CONTRIBUTING.md\` for development guidelines

Happy coding! üöÄ`
              });
            }

      - name: Summary
        run: |
          echo "## üéâ Project Initialized!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Organization | ${{ needs.configure.outputs.org }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ needs.configure.outputs.env }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Project | ${{ needs.configure.outputs.project }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tech Stack | ${{ needs.configure.outputs.techstack }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Region | ${{ needs.configure.outputs.region }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Clone the repository" >> $GITHUB_STEP_SUMMARY
          echo "2. Run \`make install\`" >> $GITHUB_STEP_SUMMARY
          echo "3. Run \`make dev\`" >> $GITHUB_STEP_SUMMARY
