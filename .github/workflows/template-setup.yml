name: Setup Project from Template

permissions:
  contents: write

on:
  create:
  push:
    branches:
      - main

jobs:
  setup:
    if: github.event.repository.name != 'azure-project-template'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Parse repository name
        id: parse
        run: |
          REPO_NAME="${{ github.event.repository.name }}"
          echo "Full repo name: $REPO_NAME"

          IFS='-' read -ra PARTS <<< "$REPO_NAME"

          ORG="${PARTS[0]}"
          ENV="${PARTS[1]}"
          PROJECT="${PARTS[2]}"
          TECHSTACK="${PARTS[3]}"

          echo "org=$ORG" >> $GITHUB_OUTPUT
          echo "env=$ENV" >> $GITHUB_OUTPUT
          echo "project=$PROJECT" >> $GITHUB_OUTPUT
          echo "techstack=$TECHSTACK" >> $GITHUB_OUTPUT

      - name: Validate parsed values
        run: |
          ORG="${{ steps.parse.outputs.org }}"
          ENV="${{ steps.parse.outputs.env }}"
          PROJECT="${{ steps.parse.outputs.project }}"
          TECHSTACK="${{ steps.parse.outputs.techstack }}"

          echo "=========================================="
          echo "Parsed values:"
          echo "  ORG:       $ORG"
          echo "  ENV:       $ENV"
          echo "  PROJECT:   $PROJECT"
          echo "  TECHSTACK: $TECHSTACK"
          echo "=========================================="

          ERRORS=0

          # Check if all values were parsed
          if [ -z "$ORG" ] || [ -z "$ENV" ] || [ -z "$PROJECT" ] || [ -z "$TECHSTACK" ]; then
            echo ""
            echo "❌ ERROR: Repository name must follow pattern: {org}-{env}-{project}-{techstack}"
            echo "   Example: nl-dev-myapp-fastapi"
            echo ""
            ERRORS=1
          fi

          # Validate org
          if [[ ! "$ORG" =~ ^(nl|pvc|tws|mys)$ ]]; then
            echo "❌ ERROR: Invalid org '$ORG'"
            echo "   Allowed values: nl, pvc, tws, mys"
            ERRORS=1
          fi

          # Validate env
          if [[ ! "$ENV" =~ ^(dev|staging|prod)$ ]]; then
            echo "❌ ERROR: Invalid env '$ENV'"
            echo "   Allowed values: dev, staging, prod"
            ERRORS=1
          fi

          # Validate project name (alphanumeric, 2-20 chars)
          if [[ ! "$PROJECT" =~ ^[a-z0-9]{2,20}$ ]]; then
            echo "❌ ERROR: Invalid project name '$PROJECT'"
            echo "   Must be 2-20 lowercase alphanumeric characters"
            ERRORS=1
          fi

          # Validate techstack
          VALID_STACKS="fastapi fastapi-hexagonal nodejs go dotnet flutter reactnative"
          if [[ ! " $VALID_STACKS " =~ " $TECHSTACK " ]]; then
            echo "❌ ERROR: Invalid techstack '$TECHSTACK'"
            echo "   Allowed values: $VALID_STACKS"
            ERRORS=1
          fi

          if [ $ERRORS -eq 1 ]; then
            echo ""
            echo "=========================================="
            echo "SETUP FAILED - Please rename your repository"
            echo "=========================================="
            echo ""
            echo "Expected format: {org}-{env}-{project}-{techstack}"
            echo ""
            echo "Examples:"
            echo "  nl-dev-myapp-fastapi"
            echo "  pvc-prod-billing-nodejs"
            echo "  tws-staging-portal-dotnet"
            echo ""
            exit 1
          fi

          echo ""
          echo "✅ All values validated successfully!"

      - name: Select tech stack template
        run: |
          TECHSTACK="${{ steps.parse.outputs.techstack }}"

          if [ -d "templates/$TECHSTACK" ]; then
            echo "✓ Using tech stack: $TECHSTACK"
            cp -r templates/$TECHSTACK/* .
          else
            echo "⚠ Tech stack '$TECHSTACK' not found, using fastapi"
            cp -r templates/fastapi/* .
          fi

          rm -rf templates/

      - name: Process template files
        run: |
          ORG="${{ steps.parse.outputs.org }}"
          ENV="${{ steps.parse.outputs.env }}"
          PROJECT="${{ steps.parse.outputs.project }}"
          TECHSTACK="${{ steps.parse.outputs.techstack }}"
          RESOURCE_GROUP="${ORG}-${ENV}-${PROJECT}-weu-rg"

          # Process .template files
          find . -name "*.template" -type f | while read file; do
            output="${file%.template}"
            sed -e "s/{{ORG}}/$ORG/g" \
                -e "s/{{ENV}}/$ENV/g" \
                -e "s/{{PROJECT}}/$PROJECT/g" \
                -e "s/{{TECHSTACK}}/$TECHSTACK/g" \
                -e "s/{{RESOURCE_GROUP}}/$RESOURCE_GROUP/g" \
                "$file" > "$output"
            rm "$file"
          done

          # Replace placeholders in ALL text files
          find . -type f \( \
            -name "*.py" -o \
            -name "*.cs" -o \
            -name "*.js" -o \
            -name "*.ts" -o \
            -name "*.tsx" -o \
            -name "*.jsx" -o \
            -name "*.go" -o \
            -name "*.dart" -o \
            -name "*.java" -o \
            -name "*.bicepparam" -o \
            -name "*.bicep" -o \
            -name "*.json" -o \
            -name "*.md" -o \
            -name "*.yml" -o \
            -name "*.yaml" -o \
            -name "*.env*" -o \
            -name "*.txt" -o \
            -name "*.toml" -o \
            -name "*.ini" -o \
            -name "*.conf" -o \
            -name "Dockerfile*" \
          \) -exec sed -i \
            -e "s/{{ORG}}/$ORG/g" \
            -e "s/{{ENV}}/$ENV/g" \
            -e "s/{{PROJECT}}/$PROJECT/g" \
            -e "s/{{TECHSTACK}}/$TECHSTACK/g" \
            -e "s/{{RESOURCE_GROUP}}/$RESOURCE_GROUP/g" \
            {} +

      - name: Rename project-specific files
        run: |
          PROJECT="${{ steps.parse.outputs.project }}"
          find . -name "*{{PROJECT}}*" -type f | while read file; do
            newname=$(echo "$file" | sed "s/{{PROJECT}}/$PROJECT/g")
            mv "$file" "$newname"
          done

      - name: Commit changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add .
          git diff --staged --quiet || git commit -m "chore: Configure from template"

      - name: Push changes
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref }}
